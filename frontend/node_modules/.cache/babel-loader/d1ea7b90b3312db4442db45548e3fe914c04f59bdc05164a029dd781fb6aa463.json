{"ast":null,"code":"import{useState,useEffect}from'react';import filesApi from'../api/files';import FileItem from'../components/FileItem';import{useNavigate}from'react-router-dom';import{formatBytes,formatDate}from'../utils/helpers';import useAuthStore from\"../stores/authStore\";import{saveAs}from\"file-saver\";import{decryptFile,decryptWithPrivateKey,encryptWithPublicKey}from\"../utils/crypto\";import Spinner from\"../components/Spinner\";import{toast}from'react-toastify';import usePrivateKeyStore from\"../stores/privateKeyStore\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";export default function MyFiles(){const{isAuthenticated}=useAuthStore();const navigate=useNavigate();const{privateKey}=usePrivateKeyStore();useEffect(()=>{if(!isAuthenticated){navigate(\"/signin\");}},[isAuthenticated,navigate]);const[files,setFiles]=useState([]);const[loading,setLoading]=useState(true);const[downloadingFile,setDownloadingFile]=useState(null);const fetchFiles=async()=>{try{const response=await filesApi.getMyFiles();setFiles(response.data.files);}catch(err){toast.warn(\"Ошибка загрузки файла\");}finally{setLoading(false);}};useEffect(()=>{fetchFiles();},[]);const handleDownload=async(file,encryptedAesKey,privateKey)=>{if(!privateKey){toast.warn('Пожалуйста, сначала загрузите свой закрытый ключ, чтобы расшифровать файлы.');return;}setDownloadingFile(file.id);try{let response;if(!encryptedAesKey){response=await filesApi.downloadCommonFile(file.id);}else{response=await filesApi.downloadFile(file.id);}if(!response.data||!(response.data instanceof ArrayBuffer)){var _response$data,_response$data$constr;throw new Error(\"Invalid data type: \".concat((_response$data=response.data)===null||_response$data===void 0?void 0:(_response$data$constr=_response$data.constructor)===null||_response$data$constr===void 0?void 0:_response$data$constr.name));}let blob;if(!encryptedAesKey){blob=new Blob([response.data]);}else{blob=await decryptFile(response.data,encryptedAesKey,privateKey);}saveAs(blob,file.name);}catch(error){toast.error('Не удалось загрузить файл. Попробуйте еще раз.');}finally{setDownloadingFile(null);}};const handleDelete=async fileUuid=>{try{await filesApi.deleteFile(fileUuid);await fetchFiles();toast.success('Файл успешно удален.');}catch(err){toast.error('Не удалось удалить файл.');}};const handleShare=async(fileUuid,encryptedAesKey,recipientPublicKey,recipientUuid)=>{const symmetricKey=await decryptWithPrivateKey(encryptedAesKey,privateKey);encryptedAesKey=await encryptWithPublicKey(symmetricKey,recipientPublicKey);await filesApi.shareFile(fileUuid,{recipient_uuid:recipientUuid,symmetric_key:encryptedAesKey});};if(loading)return/*#__PURE__*/_jsxs(\"div\",{className:\"loading-container\",children:[/*#__PURE__*/_jsx(Spinner,{size:\"large\",color:\"primary\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Loading files...\"})]});return/*#__PURE__*/_jsxs(\"div\",{className:\"files-list\",children:[!privateKey&&/*#__PURE__*/_jsx(\"div\",{className:\"key-warning\",children:/*#__PURE__*/_jsx(\"span\",{children:\"\\u26A0\\uFE0F \\u0412\\u0430\\u043C \\u043D\\u0435\\u043E\\u0431\\u0445\\u043E\\u0434\\u0438\\u043C\\u043E \\u0437\\u0430\\u0433\\u0440\\u0443\\u0437\\u0438\\u0442\\u044C \\u0441\\u0432\\u043E\\u0439 \\u0437\\u0430\\u043A\\u0440\\u044B\\u0442\\u044B\\u0439 \\u043A\\u043B\\u044E\\u0447 \\u0434\\u043B\\u044F \\u0440\\u0430\\u0441\\u0448\\u0438\\u0444\\u0440\\u043E\\u0432\\u043A\\u0438 \\u0444\\u0430\\u0439\\u043B\\u043E\\u0432.\"})}),files.length>0?files.map(file=>/*#__PURE__*/_jsx(FileItem,{file:{id:file.uuid,name:file.name,size:formatBytes(file.size),date:formatDate(file.created_at),encryptedKey:file.symmetric_key},onDownload:()=>handleDownload({id:file.uuid,name:file.name},file.symmetric_key,privateKey),onShare:handleShare,onDelete:handleDelete,isOwner:true,isDownloading:downloadingFile===file.uuid,isDisabled:!privateKey},file.uuid)):/*#__PURE__*/_jsx(\"p\",{className:\"empty-message\",children:\"\\u0423 \\u0432\\u0430\\u0441 \\u043D\\u0435\\u0442 \\u043D\\u0438\\u043A\\u0430\\u043A\\u0438\\u0445 \\u0444\\u0430\\u0439\\u043B\\u043E\\u0432.\"})]});}","map":{"version":3,"names":["useState","useEffect","filesApi","FileItem","useNavigate","formatBytes","formatDate","useAuthStore","saveAs","decryptFile","decryptWithPrivateKey","encryptWithPublicKey","Spinner","toast","usePrivateKeyStore","jsx","_jsx","jsxs","_jsxs","MyFiles","isAuthenticated","navigate","privateKey","files","setFiles","loading","setLoading","downloadingFile","setDownloadingFile","fetchFiles","response","getMyFiles","data","err","warn","handleDownload","file","encryptedAesKey","id","downloadCommonFile","downloadFile","ArrayBuffer","_response$data","_response$data$constr","Error","concat","constructor","name","blob","Blob","error","handleDelete","fileUuid","deleteFile","success","handleShare","recipientPublicKey","recipientUuid","symmetricKey","shareFile","recipient_uuid","symmetric_key","className","children","size","color","length","map","uuid","date","created_at","encryptedKey","onDownload","onShare","onDelete","isOwner","isDownloading","isDisabled"],"sources":["/home/sergey/univer/frontend/src/pages/MyFiles.jsx"],"sourcesContent":["import { useState, useEffect } from 'react';\nimport filesApi from '../api/files';\nimport FileItem from '../components/FileItem';\nimport { useNavigate } from 'react-router-dom';\nimport { formatBytes, formatDate } from '../utils/helpers';\nimport useAuthStore from \"../stores/authStore\"\nimport { saveAs } from \"file-saver\";\nimport {decryptFile, decryptWithPrivateKey, encryptWithPublicKey} from \"../utils/crypto\";\nimport Spinner from \"../components/Spinner\";\nimport { toast } from 'react-toastify';\nimport usePrivateKeyStore from \"../stores/privateKeyStore\";\n\nexport default function MyFiles() {\n    const { isAuthenticated } = useAuthStore();\n    const navigate = useNavigate();\n    const { privateKey } = usePrivateKeyStore();\n\n    useEffect(() => {\n        if (!isAuthenticated) {\n            navigate(\"/signin\");\n        }\n    }, [isAuthenticated, navigate]);\n\n    const [files, setFiles] = useState([]);\n    const [loading, setLoading] = useState(true);\n    const [downloadingFile, setDownloadingFile] = useState(null);\n\n    const fetchFiles = async () => {\n        try {\n            const response = await filesApi.getMyFiles();\n            setFiles(response.data.files);\n        } catch (err) {\n            toast.warn(\"Ошибка загрузки файла\");\n        } finally {\n            setLoading(false);\n        }\n    };\n\n    useEffect(() => {\n        fetchFiles();\n    }, []);\n\n    const handleDownload = async (file, encryptedAesKey, privateKey) => {\n        if (!privateKey) {\n            toast.warn('Пожалуйста, сначала загрузите свой закрытый ключ, чтобы расшифровать файлы.');\n            return;\n        }\n\n        setDownloadingFile(file.id);\n        try {\n            let response\n            if (!encryptedAesKey) {\n                response = await filesApi.downloadCommonFile(file.id);\n            }else {\n                response = await filesApi.downloadFile(file.id);\n            }\n\n            if (!response.data || !(response.data instanceof ArrayBuffer)) {\n                throw new Error(`Invalid data type: ${response.data?.constructor?.name}`);\n            }\n\n            let blob\n            if (!encryptedAesKey) {\n                blob = new Blob([response.data]);\n            } else {\n                blob = await decryptFile(\n                    response.data,\n                    encryptedAesKey,\n                    privateKey\n                );\n            }\n\n            saveAs(blob, file.name);\n        } catch (error) {\n            toast.error('Не удалось загрузить файл. Попробуйте еще раз.');\n        } finally {\n            setDownloadingFile(null);\n        }\n    }\n\n    const handleDelete = async (fileUuid) => {\n        try {\n            await filesApi.deleteFile(fileUuid);\n            await fetchFiles();\n            toast.success('Файл успешно удален.');\n        } catch (err) {\n            toast.error('Не удалось удалить файл.');\n        }\n    };\n\n    const handleShare = async (fileUuid, encryptedAesKey, recipientPublicKey, recipientUuid) => {\n        const symmetricKey = await decryptWithPrivateKey(encryptedAesKey, privateKey);\n\n        encryptedAesKey = await encryptWithPublicKey(symmetricKey, recipientPublicKey);\n\n        await filesApi.shareFile(fileUuid, {\n            recipient_uuid: recipientUuid,\n            symmetric_key: encryptedAesKey,\n        });\n    };\n\n    if (loading) return (\n        <div className=\"loading-container\">\n            <Spinner size=\"large\" color=\"primary\" />\n            <p>Loading files...</p>\n        </div>\n    );\n\n    return (\n        <div className=\"files-list\">\n            {!privateKey && (\n                <div className=\"key-warning\">\n                    <span>⚠️ Вам необходимо загрузить свой закрытый ключ для расшифровки файлов.</span>\n                </div>\n            )}\n\n            {files.length > 0 ? (\n                files.map((file) => (\n                    <FileItem\n                        key={file.uuid}\n                        file={{\n                            id: file.uuid,\n                            name: file.name,\n                            size: formatBytes(file.size),\n                            date: formatDate(file.created_at),\n                            encryptedKey: file.symmetric_key\n                        }}\n                        onDownload={() => handleDownload({\n                            id: file.uuid,\n                            name: file.name,\n                        }, file.symmetric_key, privateKey)}\n                        onShare={handleShare}\n                        onDelete={handleDelete}\n                        isOwner={true}\n                        isDownloading={downloadingFile === file.uuid}\n                        isDisabled={!privateKey}\n                    />\n                ))\n            ) : (\n                <p className=\"empty-message\">У вас нет никаких файлов.</p>\n            )}\n        </div>\n    );\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}