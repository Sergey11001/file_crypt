{"ast":null,"code":"import{useState}from'react';import{Link,Outlet,useLocation,useNavigate}from'react-router-dom';import PrivateKeyUpload from'../components/PrivateKeyUpload';import{toast}from\"react-toastify\";import{exportPrivateKey,exportPublicKey,generateKeyPair}from\"../utils/crypto\";import useAuthStore from\"../stores/authStore\";import usersApi from\"../api/users\";import usePrivateKeyStore from\"../stores/privateKeyStore\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";export default function FileStorage(){const{user,signOut}=useAuthStore();const{clearAll}=usePrivateKeyStore();const location=useLocation();const navigate=useNavigate();const[activeTab,setActiveTab]=useState(location.pathname.includes('shared')?'shared':'my');const[isRegenerating,setIsRegenerating]=useState(false);const[showConfirmModal,setShowConfirmModal]=useState(false);const handleLogout=()=>{clearAll();signOut();navigate('/signin');};const handleRegenerate=async()=>{setIsRegenerating(true);try{await regenerateKeys();toast.success('Ключи успешно сгенерированы!');window.location.reload();}catch(error){toast.error(\"\\u041D\\u0435 \\u0443\\u0434\\u0430\\u043B\\u043E\\u0441\\u044C \\u043F\\u043E\\u0432\\u0442\\u043E\\u0440\\u043D\\u043E \\u0441\\u0433\\u0435\\u043D\\u0435\\u0440\\u0438\\u0440\\u043E\\u0432\\u0430\\u0442\\u044C \\u043A\\u043B\\u044E\\u0447\\u0438: \".concat(error.message));}finally{setIsRegenerating(false);setShowConfirmModal(false);}};const regenerateKeys=async()=>{const keyPair=await generateKeyPair();const publicKey=await exportPublicKey(keyPair.publicKey);const privateKeyPem=await exportPrivateKey(keyPair.privateKey);await usersApi.updateUserKeys({public_key:publicKey});localStorage.setItem('public_key',publicKey);const blob=new Blob([privateKeyPem],{type:'application/x-pem-file'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=\"filecrypt_\".concat(user.email,\"_private_key.pem\");document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);clearAll();};return/*#__PURE__*/_jsxs(\"div\",{className:\"file-storage-container\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"file-storage-top\",children:[/*#__PURE__*/_jsx(\"h2\",{children:\"\\u0425\\u0440\\u0430\\u043D\\u0438\\u043B\\u0438\\u0449\\u0435 \\u0444\\u0430\\u0439\\u043B\\u043E\\u0432\"}),/*#__PURE__*/_jsx(\"button\",{onClick:handleLogout,className:\"logout-btn\",children:\"\\u0412\\u044B\\u0439\\u0442\\u0438\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"key-upload-section\",children:[/*#__PURE__*/_jsx(PrivateKeyUpload,{}),/*#__PURE__*/_jsx(\"button\",{className:\"regenerate-keys-button\",onClick:()=>setShowConfirmModal(true),disabled:isRegenerating,children:isRegenerating?'Перевыпуск...':'Перевыпуск ключей'}),showConfirmModal&&/*#__PURE__*/_jsx(\"div\",{className:\"modal-overlay\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"modal-content\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"modal-close\",onClick:()=>setShowConfirmModal(false),children:\"\\xD7\"}),/*#__PURE__*/_jsx(\"h3\",{children:\"\\u041F\\u043E\\u0434\\u0442\\u0432\\u0435\\u0440\\u0434\\u0438\\u0442\\u0435 \\u043F\\u0435\\u0440\\u0435\\u0432\\u044B\\u043F\\u0443\\u0441\\u043A \\u043A\\u043B\\u044E\\u0447\\u0435\\u0439\"}),/*#__PURE__*/_jsx(\"p\",{children:\"\\u042D\\u0442\\u043E \\u0441\\u0434\\u0435\\u043B\\u0430\\u0435\\u0442 \\u0432\\u0430\\u0448\\u0438 \\u0442\\u0435\\u043A\\u0443\\u0449\\u0438\\u0435 \\u043A\\u043B\\u044E\\u0447\\u0438 \\u043D\\u0435\\u0434\\u0435\\u0439\\u0441\\u0442\\u0432\\u0438\\u0442\\u0435\\u043B\\u044C\\u043D\\u044B\\u043C\\u0438 \\u0438 \\u0443\\u0434\\u0430\\u043B\\u0438\\u0442 \\u0432\\u0441\\u0435 \\u0432\\u0430\\u0448\\u0438 \\u0444\\u0430\\u0439\\u043B\\u044B. \\u0412\\u044B \\u0443\\u0432\\u0435\\u0440\\u0435\\u043D\\u044B, \\u0447\\u0442\\u043E \\u0445\\u043E\\u0442\\u0438\\u0442\\u0435 \\u043F\\u0440\\u043E\\u0434\\u043E\\u043B\\u0436\\u0438\\u0442\\u044C?\"}),/*#__PURE__*/_jsx(\"div\",{className:\"modal-actions\",children:/*#__PURE__*/_jsx(\"button\",{type:\"submit\",className:\"btn-confirm\",onClick:handleRegenerate,disabled:isRegenerating,children:isRegenerating?'Обработка...':'Подтвердить'})})]})})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"tabs-container\",children:[/*#__PURE__*/_jsx(Link,{to:\"/storage/my\",className:\"tab \".concat(activeTab==='my'?'active':''),onClick:()=>setActiveTab('my'),children:\"\\u041C\\u043E\\u0438 \\u0444\\u0430\\u0439\\u043B\\u044B\"}),/*#__PURE__*/_jsx(Link,{to:\"/storage/shared\",className:\"tab \".concat(activeTab==='shared'?'active':''),onClick:()=>setActiveTab('shared'),children:\"\\u0414\\u043E\\u0441\\u0442\\u0443\\u043F\\u043D\\u044B\\u0435 \\u0444\\u0430\\u0439\\u043B\\u044B\"})]}),/*#__PURE__*/_jsx(\"div\",{className:\"add-file-btn-container\",children:/*#__PURE__*/_jsx(Link,{to:\"/upload\",className:\"add-file-btn\",children:\"+ \\u0414\\u043E\\u0431\\u0430\\u0432\\u0438\\u0442\\u044C \\u0444\\u0430\\u0439\\u043B\"})}),/*#__PURE__*/_jsx(\"div\",{className:\"files-content\",children:/*#__PURE__*/_jsx(Outlet,{})})]});}","map":{"version":3,"names":["useState","Link","Outlet","useLocation","useNavigate","PrivateKeyUpload","toast","exportPrivateKey","exportPublicKey","generateKeyPair","useAuthStore","usersApi","usePrivateKeyStore","jsx","_jsx","jsxs","_jsxs","FileStorage","user","signOut","clearAll","location","navigate","activeTab","setActiveTab","pathname","includes","isRegenerating","setIsRegenerating","showConfirmModal","setShowConfirmModal","handleLogout","handleRegenerate","regenerateKeys","success","window","reload","error","concat","message","keyPair","publicKey","privateKeyPem","privateKey","updateUserKeys","public_key","localStorage","setItem","blob","Blob","type","url","URL","createObjectURL","a","document","createElement","href","download","email","body","appendChild","click","removeChild","revokeObjectURL","className","children","onClick","disabled","to"],"sources":["/home/sergey/univer/frontend/src/pages/FileStorage.jsx"],"sourcesContent":["import {useState} from 'react';\nimport { Link, Outlet, useLocation, useNavigate } from 'react-router-dom';\nimport PrivateKeyUpload from '../components/PrivateKeyUpload';\nimport {toast} from \"react-toastify\";\nimport {exportPrivateKey, exportPublicKey, generateKeyPair} from \"../utils/crypto\";\nimport useAuthStore from \"../stores/authStore\"\nimport usersApi from \"../api/users\";\nimport usePrivateKeyStore from \"../stores/privateKeyStore\";\n\nexport default function FileStorage() {\n    const {user, signOut} = useAuthStore()\n    const {clearAll} = usePrivateKeyStore()\n    const location = useLocation();\n    const navigate = useNavigate();\n    const [activeTab, setActiveTab] = useState(\n        location.pathname.includes('shared') ? 'shared' : 'my'\n    );\n    const [isRegenerating, setIsRegenerating] = useState(false);\n    const [showConfirmModal, setShowConfirmModal] = useState(false);\n\n    const handleLogout = () => {\n        clearAll()\n        signOut()\n        navigate('/signin');\n    };\n\n    const handleRegenerate = async () => {\n        setIsRegenerating(true);\n        try {\n            await regenerateKeys();\n            toast.success('Ключи успешно сгенерированы!');\n            window.location.reload();\n        } catch (error) {\n            toast.error(`Не удалось повторно сгенерировать ключи: ${error.message}`);\n        } finally {\n            setIsRegenerating(false);\n            setShowConfirmModal(false);\n        }\n    };\n\n    const regenerateKeys = async () => {\n        const keyPair = await generateKeyPair();\n        const publicKey = await exportPublicKey(keyPair.publicKey);\n        const privateKeyPem = await exportPrivateKey(keyPair.privateKey);\n\n        await usersApi.updateUserKeys({\n            public_key: publicKey,\n        })\n\n        localStorage.setItem('public_key', publicKey);\n\n        const blob = new Blob([privateKeyPem], { type: 'application/x-pem-file' });\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = `filecrypt_${user.email}_private_key.pem`;\n        document.body.appendChild(a);\n        a.click();\n        document.body.removeChild(a);\n        URL.revokeObjectURL(url);\n\n        clearAll()\n    }\n\n    return (\n        <div className=\"file-storage-container\">\n            <div className=\"file-storage-top\">\n                <h2>Хранилище файлов</h2>\n                <button\n                    onClick={handleLogout}\n                    className=\"logout-btn\"\n                >\n                    Выйти\n                </button>\n            </div>\n\n            <div className=\"key-upload-section\">\n                <PrivateKeyUpload />\n                <button\n                    className=\"regenerate-keys-button\"\n                    onClick={() => setShowConfirmModal(true)}\n                    disabled={isRegenerating}\n                >\n                    {isRegenerating ? 'Перевыпуск...' : 'Перевыпуск ключей'}\n                </button>\n\n                {showConfirmModal && (\n                    <div className=\"modal-overlay\">\n                        <div className=\"modal-content\">\n                            <button\n                                className=\"modal-close\"\n                                onClick={() => setShowConfirmModal(false)}\n                            >\n                                &times;\n                            </button>\n\n                            <h3>Подтвердите перевыпуск ключей</h3>\n                            <p>Это сделает ваши текущие ключи недействительными и удалит все ваши файлы. Вы уверены, что хотите продолжить?</p>\n                            <div className=\"modal-actions\">\n                                <button\n                                    type=\"submit\"\n                                    className=\"btn-confirm\"\n                                    onClick={handleRegenerate}\n                                    disabled={isRegenerating}\n                                >\n                                    {isRegenerating ? 'Обработка...' : 'Подтвердить'}\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                )}\n            </div>\n\n            <div className=\"tabs-container\">\n                <Link\n                    to=\"/storage/my\"\n                    className={`tab ${activeTab === 'my' ? 'active' : ''}`}\n                    onClick={() => setActiveTab('my')}\n                >\n                    Мои файлы\n                </Link>\n                <Link\n                    to=\"/storage/shared\"\n                    className={`tab ${activeTab === 'shared' ? 'active' : ''}`}\n                    onClick={() => setActiveTab('shared')}\n                >\n                    Доступные файлы\n                </Link>\n            </div>\n\n            <div className=\"add-file-btn-container\">\n                <Link to=\"/upload\" className=\"add-file-btn\">\n                    + Добавить файл\n                </Link>\n            </div>\n\n            {/* Контент страницы */}\n            <div className=\"files-content\">\n                <Outlet />\n            </div>\n        </div>\n    );\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}